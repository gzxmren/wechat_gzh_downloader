## [v4.5] - 2026-01-24

### 🚀 异步架构升级 (Asynchronous Upgrade)
- **全面异步化**: 将核心链路（下载、图片处理、文件保存、PDF 生成）从同步阻塞重构为异步非阻塞。基于 `asyncio` 和 `aiohttp` 实现，极大提升了网络 I/O 密集的处理效率。
- **全局并发控制 (`--concurrency`)**: 引入 `asyncio.Semaphore` 机制，支持通过命令行自定义全局并发抓取的文章数量（默认 3）。在提升速度的同时，通过随机交错启动 (Staggered Start) 保护账号安全，有效规避微信反爬风险。
- **图片并行下载**: 针对富媒体文章，实现了单篇文章内所有图片的 `asyncio.gather` 并行下载模式，处理速度相比同步模式提升 300%+。

### 🔧 性能与稳定性优化 (Performance & Stability)
- **非阻塞 I/O**: 集成 `aiofiles`，将磁盘读写操作（HTML、Markdown、Metadata）全部异步化，确保在高并发下主线程事件循环不卡顿。
- **连接池复用**: 在主循环中共享 `ClientSession`，大幅减少了高频请求时的 TCP 握手开销和系统资源占用。
- **进程隔离保护**: 针对 `wkhtmltopdf` 资源密集型任务，引入了独立的 `PDF_SEMAPHORE` 信号量（限制并发为 2），确保在高并发环境下系统 CPU 不会被 PDF 生成任务瞬间压垮。

---

## [v4.4] - 2026-01-23

### 🏗️ 架构重构 (Refactoring)
- **策略模式 (Strategy Pattern)**: 彻底重构了核心下载逻辑，将解析器解耦为独立的 `parsers` 模块。引入 `BaseParser` 基类，实现了 `StandardParser`（标准图文）和 `ImageDetailParser`（图片频道）的分离，显著提升了代码的可维护性和扩展性（为未来支持视频解析奠定基础）。
- **Fail-Safe 调度器**: 新增 `parse_html` 调度函数，采用“标准优先，失败降级”的策略。当标准解析器无法提取正文时，自动无缝切换至图片频道解析器，确保最大程度的解析成功率。

### 🔧 核心修复 (Bug Fixes)
- **图片提取逻辑修正**: 修复了 `ImageDetailParser` 中因正则贪婪匹配导致的图片提取数量错误（过多或过少）的问题。
- **对象块隔离**: 引入了更严谨的“对象块拆分”逻辑，先将 JS 数组切分为独立对象，再在每个对象内提取**首个**有效的 `cdn_url`，完美过滤了水印图和缩略图的干扰。
- **转义字符安全**: 彻底修复了代码生成过程中因反斜杠转义 (`\x`, `\u`) 引发的 Python 语法错误，增强了对 Unicode 编码的处理能力。

---

## [v4.3] - 2026-01-23

### ✨ 新增功能 (New Features)
- **精准图片提取 (Precise Extraction)**: 针对微信“图片频道”类文章，引入了 **Balanced Parentheses (括号平衡)** 算法与 **Object Block Isolation (对象块隔离)** 逻辑。能够精准识别嵌套的 JavaScript 数组边界，彻底解决了因非贪婪正则匹配导致的图片截断问题。
- **智能去重与过滤**: 实现了基于 URL 路径的强力去重（忽略协议头及不可见字符），并坚持“对象块首选原则”，有效过滤了文章正文之外的水印图、缩略图等干扰项。

### 🔧 稳定性修复 (Bug Fixes)
- **标题回退增强 (Title Fallback)**: 增强了对非标准页面标题的提取能力，优先匹配 `og:title` 等元标签，解决了部分文章文件名显示为 `Untitled_Article` 的问题。
- **转义字符处理**: 修正了从 JS 提取 URL 时可能出现的 Unicode 转义字符（如 `\u`）解析错误。

---

## [v4.2] - 2026-01-23

## [v4.1] - 2026-01-23

### ✨ 新增功能 (New Features)
- **元数据生成 (Metadata)**: 每篇文章的目录下自动生成 `metadata.json`，包含标题、作者、发布日期、原文链接及下载时间等关键信息，便于第三方工具集成。
- **全局索引 (Global Index)**: 在输出根目录下自动生成 `index.html`（现代化 UI），按时间倒序列出所有已下载文章，支持一键本地阅读和跳转原文。
- **内容清洗 (Clean Content)**: 深度清洗 HTML 内容，自动移除底部的二维码、广告栏、点赞/在看工具条和赞赏区域，显著提升 Markdown 和 PDF 的阅读纯净度。

### 🚀 功能提升 (Improvements)
- **UI 升级**: 全局索引页面采用 Material Design 风格，响应式布局，阅读体验更佳。
- **流程优化**: 即使没有新任务，程序现在也会自动扫描输出目录并重建索引文件，方便管理已有资产。

---

## [v4.0] - 2026-01-22

### ✨ 新增功能 (New Features)
- **默认 HTML 输出**: 程序现在默认生成包含完整样式和本地化资源的独立 HTML 文件。
- **可选输出格式**: Markdown 和 PDF 格式的生成现在通过 `--markdown` 和 `--pdf` 命令行参数进行控制，默认不激活。
- **智能文件名截断**: 优化了文件名处理逻辑，确保文章标题在作为文件名时不会因过长而导致系统错误，文件名长度严格限制在100个字符以内。
- **PDF 容错机制**: 增强 PDF 生成的健壮性，当检测到 wkhtmltopdf 环境不支持高级功能（如目录和页码）时，能自动退化为生成普通 PDF，避免程序中断。

### 🚀 功能提升 (Improvements)
- **渲染逻辑重构**: 深度优化 Markdown 转换逻辑，优先采用标准 HTML 解析以完整保留文章的正文、标题层级和图片排版，有效解决了“图文文章”被误判为“相册页面”导致的正文丢失问题。
- **发布日期自动提取**: 新增从文章 HTML 源码中自动提取 `publish_time` 或 `window.ct` 的功能，使下载的文章带有真实的原始发布日期。
- **智能数据清洗**: 增加了对原始聊天记录 (`messages.txt`) 的提取支持，可自动从混乱的文本中精准识别并去重微信文章 URL。

### 📂 目录结构优化 (Organization)
- **扁平化管理**: 输出文件夹结构由嵌套模式优化为扁平模式：`output/{文章标题}_{发布日期}/`。
- **文件对齐**: 确保 Markdown、PDF 及图片素材 (`assets/`) 均在同一级目录下，大幅提升了在 Obsidian、Zotero 等工具中的引用体验。

### 🔧 稳定性修复 (Bug Fixes)
- **正则表达式修复**: 修复了日期提取逻辑中的正则语法错误。
- **路径与命名**: 增强了对非法字符的过滤 (sanitize)，防止因特殊标题导致的目录创建失败。
- **适配器兼容性**: 解决了在某些 Python 环境下请求 URL 时可能触发的 "No connection adapters" 报错。

---

## [v3.4] - 2026-01-22
- **渲染逻辑重构**: 深度优化 Markdown 转换逻辑，优先采用标准 HTML 解析以完整保留文章的正文、标题层级和图片排版，有效解决了“图文文章”被误判为“相册页面”导致的正文丢失问题。
- **发布日期自动提取**: 新增从文章 HTML 源码中自动提取 `publish_time` 或 `window.ct` 的功能，使下载的文章带有真实的原始发布日期。
- **智能数据清洗**: 增加了对原始聊天记录 (`messages.txt`) 的提取支持，可自动从混乱的文本中精准识别并去重微信文章 URL。

### 📂 目录结构优化 (Organization)
- **扁平化管理**: 输出文件夹结构由嵌套模式优化为扁平模式：`output/{文章标题}_{发布日期}/`。
- **文件对齐**: 确保 Markdown、PDF 及图片素材 (`assets/`) 均在同一级目录下，大幅提升了在 Obsidian、Zotero 等工具中的引用体验。

### 🔧 稳定性修复 (Bug Fixes)
- **正则表达式修复**: 修复了日期提取逻辑中的正则语法错误。
- **路径与命名**: 增强了对非法字符的过滤 (sanitize)，防止因特殊标题导致的目录创建失败。
- **适配器兼容性**: 解决了在某些 Python 环境下请求 URL 时可能触发的 "No connection adapters" 报错。

---

## [v3.3] - 2026-01-15
- 支持断点续传功能 (history.log)。
- 引入基础 PDF 生成转换。
- 增加数据库解密模块初步逻辑。
