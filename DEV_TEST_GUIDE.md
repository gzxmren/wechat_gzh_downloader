# å¼€å‘ä¸æµ‹è¯•ååŒæŒ‡å— (Development & Testing Guide)

è¿™ä»½æ–‡æ¡£æ€»ç»“äº†åœ¨ç°ä»£åŒ– Python é¡¹ç›®ä¸­ï¼Œå¦‚ä½•é€šè¿‡æ¶æ„è®¾è®¡å®ç°â€œå¼€å‘ä¸æµ‹è¯•çš„é«˜æ•ˆååŒâ€ã€‚å®ƒæºè‡ªäº `WeChatDownloader` é‡æ„è¿‡ç¨‹ä¸­çš„å®æˆ˜ç»éªŒï¼Œæ—¨åœ¨æŒ‡å¯¼å¼€å‘è€…ç¼–å†™**å¯ç»´æŠ¤ã€å¯æ‰©å±•ã€å¯æµ‹è¯•**çš„é«˜è´¨é‡ä»£ç ã€‚

---

## 1. æ ¸å¿ƒç†å¿µ (Core Philosophy)

### ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦å†™æµ‹è¯•ï¼Ÿ
å¾ˆå¤šäººè®¤ä¸ºæµ‹è¯•æ˜¯â€œå†™å®Œä»£ç åçš„è¡¥æ•‘æªæ–½â€ï¼Œä½†å®é™…ä¸Šï¼Œæµ‹è¯•åº”å½“æ˜¯**å¼€å‘è¿‡ç¨‹çš„è„šæ‰‹æ¶**ã€‚
*   **é‡æ„çš„ä¿¡å¿ƒ**: åªè¦æµ‹è¯•é€šè¿‡ï¼Œä½ å°±å¯ä»¥å¤§èƒ†åœ°é‡æ„æ¶æ„ï¼ˆæ¯”å¦‚ä»å•æ–‡ä»¶è„šæœ¬æ‹†åˆ†ä¸ºæ¨¡å—ï¼‰ï¼Œè€Œä¸ç”¨æ‹…å¿ƒç ´åç°æœ‰åŠŸèƒ½ã€‚
*   **æ´»æ–‡æ¡£**: æµ‹è¯•ä»£ç æ˜¯æœ€å¥½çš„æ–‡æ¡£ï¼Œå®ƒè¯šå®åœ°å‘Šè¯‰è°ƒç”¨è€…ï¼šè¿™ä¸ªå‡½æ•°æœŸæœ›ä»€ä¹ˆè¾“å…¥ï¼Œä¼šè¿”å›ä»€ä¹ˆè¾“å‡ºã€‚
*   **è®¾è®¡è¾…åŠ©**: å¦‚æœä¸€ä¸ªå‡½æ•°å¾ˆéš¾å†™æµ‹è¯•ï¼ˆéœ€è¦ Mock å¤ªå¤šä¸œè¥¿ï¼‰ï¼Œè¯´æ˜å®ƒè®¾è®¡å¾—å¤ªå¤æ‚ï¼ˆè€¦åˆè¿‡é‡ï¼‰ï¼Œéœ€è¦æ‹†åˆ†ã€‚

---

## 2. å¯æµ‹è¯•æ€§è®¾è®¡ (Design for Testability)

ä»£ç å¥½ä¸å¥½æµ‹ï¼Œå–å†³äºä»£ç æ€ä¹ˆå†™ã€‚

### 2.1 ä¾èµ–æ³¨å…¥ (Dependency Injection)
**åæ¨¡å¼**: åœ¨ç±»å†…éƒ¨ç›´æ¥å®ä¾‹åŒ–ä¾èµ–æˆ–è¯»å–å…¨å±€å˜é‡ã€‚
```python
# ğŸ”´ éš¾ä»¥æµ‹è¯•ï¼šå¼ºä¾èµ–å…·ä½“çš„ HistoryFile
class App:
    def run(self):
        history = open("history.log") # æµ‹è¯•æ—¶å¿…é¡»çœŸçš„åˆ›å»ºä¸€ä¸ªæ–‡ä»¶
```

**æœ€ä½³å®è·µ**: å°†ä¾èµ–é¡¹é€šè¿‡æ„é€ å‡½æ•°ä¼ å…¥ã€‚
```python
# ğŸŸ¢ æ˜“äºæµ‹è¯•ï¼šå¯ä»¥ä¼ å…¥ä¸€ä¸ª Mock å¯¹è±¡æˆ–å†…å­˜ä¸­çš„å‡å¯¹è±¡
class App:
    def __init__(self, record_manager):
        self.record_manager = record_manager
```
*æ¡ˆä¾‹*: æœ¬é¡¹ç›®ä¸­çš„ `WeChatDownloaderApp` æ¥å— `args` å’Œ `RecordManager` æ³¨å…¥ï¼Œæµ‹è¯•æ—¶å¯ä»¥è½»æ¾æ›¿æ¢ä¸º `MagicMock`ã€‚

### 2.2 éš”ç¦»å‰¯ä½œç”¨ (Isolation)
å‡¡æ˜¯æ¶‰åŠ**ç½‘ç»œè¯·æ±‚ (HTTP)**ã€**æ•°æ®åº“è¯»å†™**ã€**æ–‡ä»¶ç³»ç»Ÿ (IO)** çš„æ“ä½œï¼Œéƒ½åº”å°è£…åœ¨ç‹¬ç«‹çš„æ¨¡å—ä¸­ï¼Œä»¥ä¾¿æµ‹è¯•æ—¶æ‹¦æˆªï¼ˆMockï¼‰ã€‚

*   **ç½‘ç»œå±‚**: å°è£…ä¸º `Downloader.fetch()`ã€‚æµ‹è¯•æ—¶ Mock è¿™ä¸ªæ–¹æ³•ï¼Œç›´æ¥è¿”å›é¢„è®¾çš„ HTML å­—ç¬¦ä¸²ã€‚
*   **è§£æå±‚**: çº¯å‡½æ•°è®¾è®¡ã€‚`Parser.parse(html) -> dict`ã€‚ä¸ä¾èµ–ä»»ä½•å¤–éƒ¨çŠ¶æ€ï¼Œç»™å®ƒä¸€æ ·çš„ HTMLï¼Œæ°¸è¿œè¿”å›ä¸€æ ·çš„ç»“æœã€‚è¿™æ˜¯æœ€å®¹æ˜“æµ‹è¯•çš„éƒ¨åˆ†ã€‚

### 2.3 å•ä¸€èŒè´£åŸåˆ™ (SRP)
å¦‚æœä¸€ä¸ªå‡½æ•°æ—¢è´Ÿè´£ä¸‹è½½ï¼Œåˆè´Ÿè´£è§£æï¼Œè¿˜è´Ÿè´£å­˜æ–‡ä»¶ï¼Œæµ‹è¯•å®ƒå°±éœ€è¦å‡†å¤‡ç½‘ç»œç¯å¢ƒã€å‡†å¤‡æ–‡ä»¶ç³»ç»Ÿã€‚
*   **æ‹†åˆ†å**: 
    *   `test_downloader`: åªæµ‹ç½‘ç»œè¿æ¥ã€‚
    *   `test_parser`: åªæµ‹å­—ç¬¦ä¸²å¤„ç† (No IO)ã€‚
    *   `test_saver`: åªæµ‹æ–‡ä»¶å†™å…¥ã€‚

---

## 3. æµ‹è¯•å®æˆ˜æŠ€å·§ (Testing Cheat Sheet)

åŸºäº Python æ ‡å‡†åº“ `unittest` å’Œ `unittest.mock`ã€‚

### 3.1 åŸºç¡€ç»“æ„ (`setUp` & `tearDown`)
```python
import unittest
import shutil
import os

class TestMyFeature(unittest.TestCase):
    def setUp(self):
        # ğŸ æ¯ä¸ªæµ‹è¯•å¼€å§‹å‰è¿è¡Œï¼šå‡†å¤‡å¹²å‡€çš„ç¯å¢ƒ
        self.test_dir = "temp_test_data"
        os.makedirs(self.test_dir)

    def tearDown(self):
        # ğŸ§¹ æ¯ä¸ªæµ‹è¯•ç»“æŸåè¿è¡Œï¼šæ¸…ç†åƒåœ¾ï¼Œæ— è®ºæµ‹è¯•æ˜¯å¦é€šè¿‡
        if os.path.exists(self.test_dir):
            shutil.rmtree(self.test_dir)
```

### 3.2 æ¨¡æ‹Ÿå¤–éƒ¨è°ƒç”¨ (`Mock` & `Patch`)
è¿™æ˜¯éš”ç¦»å‰¯ä½œç”¨çš„ç¥å™¨ã€‚

```python
from unittest.mock import patch, MagicMock

# åœºæ™¯ï¼šæµ‹è¯•ä¸»æµç¨‹ï¼Œä½†ä¸è¦çœŸçš„å‘ HTTP è¯·æ±‚
@patch("core.downloader.requests.get") # æ‹¦æˆª requests.get
def test_download_flow(self, mock_get):
    # 1. è®¾å®šå‰§æœ¬ (Arrange)
    mock_response = MagicMock()
    mock_response.status_code = 200
    mock_response.text = "<html>Success</html>"
    mock_get.return_value = mock_response # å½“ä»£ç è°ƒç”¨ get æ—¶ï¼Œè¿”å›è¿™ä¸ªå‡å¯¹è±¡

    # 2. æ‰§è¡Œä»£ç  (Act)
    my_app.run()

    # 3. éªŒè¯è¡Œä¸º (Assert)
    # éªŒè¯æ˜¯å¦çœŸçš„å‘èµ·äº†ä¸€æ¬¡è¯·æ±‚
    mock_get.assert_called_once() 
```

### 3.3 æ¨¡æ‹Ÿå¼‚æ­¥ä»£ç  (`AsyncMock`)
Python 3.8+ `unittest.mock` æ”¯æŒ `AsyncMock`ã€‚

```python
@patch("core.async_api.fetch_data", new_callable=AsyncMock)
async def test_async_logic(self, mock_fetch):
    mock_fetch.return_value = {"data": 123}
    
    result = await my_async_function()
    self.assertEqual(result, 123)
```

---

## 4. å®æˆ˜æ¡ˆä¾‹ï¼šæœ¬é¡¹ç›®çš„æ¼”è¿›

### Before (éš¾ä»¥æµ‹è¯•çš„è„šæœ¬)
`get_wx_gzh.py` æ˜¯ä¸€ä¸ª 500 è¡Œçš„å¤§è„šæœ¬ï¼Œæ··æ‚äº† CLI å‚æ•°è§£æã€URL å¾ªç¯ã€HTML è§£æå’Œæ–‡ä»¶å†™å…¥ã€‚
*   **ç—›ç‚¹**: æƒ³æµ‹è¯•â€œè§£æé€»è¾‘â€å¯¹ä¸å¯¹ï¼Ÿå¿…é¡»çœŸè·‘ä¸€éä¸‹è½½ï¼Œè¿˜è¦é˜²æ­¢è¢«å¾®ä¿¡å°å·ã€‚

### After (æ˜“äºæµ‹è¯•çš„æ¶æ„)
1.  **Core æ‹†è§£**: 
    *   `core/parsers/`: ç‹¬ç«‹çš„è§£æé€»è¾‘ï¼Œé…åˆ `tests/test_parsers.py` è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚ä¸è”ç½‘ï¼Œæ¯«ç§’çº§è¿è¡Œã€‚
    *   `core/app.py`: æµç¨‹æ§åˆ¶å™¨ï¼Œé…åˆ `tests/test_app_flow.py` è¿›è¡Œé›†æˆæµ‹è¯•ã€‚ä½¿ç”¨ `Mock` æ¨¡æ‹Ÿä¸‹è½½æˆåŠŸ/å¤±è´¥çš„å„ç§åœºæ™¯ã€‚
2.  **RecordManager**: å°†æ–‡ä»¶è¯»å†™å°è£…ã€‚æµ‹è¯•æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¸´æ—¶è®©å®ƒè¯»å†™ `tests/temp_dir/` ä¸‹çš„ CSVï¼Œè€Œä¸å½±å“ç”Ÿäº§ç¯å¢ƒçš„ `wechat_records.csv`ã€‚

---

## 5. æ¨èå·¥ä½œæµ (Workflow)

1.  **æ˜ç¡®éœ€æ±‚**: "æˆ‘è¦æ”¯æŒä¸€ä¸ªæ–°çš„è§†é¢‘ç½‘ç«™è§£æ"ã€‚
2.  **ç¼–å†™æµ‹è¯• (TDD)**: 
    *   åˆ›å»ºä¸€ä¸ª `tests/test_video_parser.py`ã€‚
    *   æ‰¾ä¸€æ®µè¯¥ç½‘ç«™çš„ HTML æ ·æœ¬ã€‚
    *   å†™æ–­è¨€ï¼š`expect(parser.parse(html)).toEqual(video_url)`ã€‚
3.  **å®ç°åŠŸèƒ½**: ç¼–å†™è§£æå™¨ä»£ç ï¼Œç›´åˆ°æµ‹è¯•è·‘é€š (Green)ã€‚
4.  **é›†æˆ**: åœ¨ `App` ç±»ä¸­æ³¨å†Œæ–°è§£æå™¨ã€‚
5.  **å›å½’æµ‹è¯•**: è¿è¡Œ `python -m unittest discover tests`ï¼Œç¡®ä¿æ²¡æ”¹ååˆ«çš„ä¸œè¥¿ã€‚

éµå¾ªæ­¤æŒ‡å—ï¼Œæ‚¨çš„ä»£ç åº“å°†éšç€åŠŸèƒ½çš„å¢åŠ è€Œå˜å¾—æ›´åŠ ç¨³å›ºï¼Œè€Œä¸æ˜¯æ—¥ç›Šè„†å¼±ã€‚
